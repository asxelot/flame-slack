function ChannelCtrl(e,n,t,r,i,a,o,s,l,c){return a?t.channel&&i.hasOwnProperty(t.channel)?(e.channels||(n.channels=i),e.users||(n.users=s.all),e.channel=t.channel,e.msg={},e.divider=e.user.lastReaded&&e.user.lastReaded[e.channel],l.set(e.channel),e.channels.$ref().on("child_added",function(t){e.messages||(n.messages={}),e.messages[t.key()]=o(t.key())}),e.$watchCollection("messages."+e.channel,function(n){e.user.lastReaded=e.user.lastReaded||{},e.user.lastReaded[e.channel]=n.length&&n[n.length-1].$id,e.user.$save()}),new Firebase(c+"messages/").on("child_changed",function(){e.isTabActive||l.add("* ")}),e.$on("mention",function(){e.isTabActive||l.add("! ")}),e.$on("tab-active",function(e,n){n&&l.remove()}),e.addMessage=function(){e.msg.text&&(e.msg.channel=e.channel,e.msg.timestamp=Firebase.ServerValue.TIMESTAMP,e.msg.author={id:e.user.$id,username:e.user.username,avatar:e.user.avatar},e.messages[e.channel].$add(e.msg),e.msg={})},e.remove=function(n){e.messages[e.channel].$remove(n)},void(e.createChannel=function(){e.newChannelForm.$invalid||(e.channels[e.newChannelName]=!0,e.channels.$save(),e.messages[e.newChannelName]=o(e.newChannelName),e.newChannelName="",e.isNewChannelFormShowed=!1)})):r.path("channels/general"):r.path("/login")}function DirectCtrl(e,n,t,r,i,a,o,s,l,c){return a?(i.hasOwnProperty(t.user)||console.log("user not found"),e.users||(n.users=s.all),e.channels||(n.channels=o),e.directNotify||(n.directNotify=l.notifications(e.user.$id)),e.msg={},e.directWith={$id:i[t.user],username:t.user},e.messages=l.messages(e.user.$id,e.directWith.$id),l.removeNotifications(e.user.$id,e.directWith.$id),void(e.addMessage=function(){e.msg.text&&(e.msg.timestamp=Firebase.ServerValue.TIMESTAMP,e.msg.author={id:e.user.$id,username:e.user.username,avatar:e.user.avatar},e.messages.$add(e.msg),l.notify(e.user.$id,e.directWith.$id),e.msg={})})):r.path("/login")}function LoginCtrl(e,n,t,r,i){return e.newUser={},i?n.path("/channels"):void(e.login=function(){t.$authWithPassword(e.newUser).then(function(e){r.setOnline(e.uid),n.path("/channels")})["catch"](console.error)})}function MainCtrl(e,n,t,r,i,a){r.$onAuth(function(e){e?(n.user=i.getProfile(e.uid),i.setOnline(e.uid),n.isAdmin=i.isAdmin(e.uid)):(n.user=null,t.path("/login"))}),e.lightbox=function(n){e.lightboxSrc=n},e.logout=function(){i.setOffline(e.user.$id),r.$unauth()}}function RegisterCtrl(e,n,t,r,i,a){return e.usernames=i,e.newUser={},a?n.path("/channels"):void(e.register=function(){return e.RegisterForm.$invalid?void 0:e.usernames[e.newUser.username]?console.log("this username already exists"):void t.$createUser(e.newUser).then(function(n){return t.$authWithPassword(e.newUser)}).then(function(t){r.setOnline(t.uid);var i=r.getProfile(t.uid);e.usernames[e.newUser.username]=t.uid,e.usernames.$save(),i.username=e.newUser.username,i.avatar=t.password.profileImageURL,i.$save(),r.all.$save(),n.path("/channels")})})}angular.module("FlameSlackApp",["ngRoute","firebase","ui.bootstrap","ngSanitize"]).constant("FB","https://flame-slack.firebaseio.com/").config(["$routeProvider",function(e){e.when("/login",{controller:"LoginCtrl",templateUrl:"views/login.html",resolve:{isLogged:["Auth",function(e){return e.$waitForAuth()}]}}).when("/register",{controller:"RegisterCtrl",templateUrl:"views/register.html",resolve:{usernames:["Usernames",function(e){return e.$loaded()}],isLogged:["Auth",function(e){return e.$waitForAuth()}]}}).when("/channels/:channel?",{controller:"ChannelCtrl",templateUrl:"views/chat.html",resolve:{channels:["Channels",function(e){return e.$loaded()}],isLogged:["Auth",function(e){return e.$waitForAuth()}]}}).when("/messages/:user",{controller:"DirectCtrl",templateUrl:"views/chat.html",resolve:{usernames:["Usernames",function(e){return e.$loaded()}],isLogged:["Auth",function(e){return e.$waitForAuth()}]}})}]),angular.module("FlameSlackApp").directive("ngAutoscroll",function(){function e(e,n){function t(){i&&(r.scrollTop=r.scrollHeight)}var r=n[0],i=!0,a=0,o="webkitfullscreenchange mozfullscreenchange fullscreenchange";n.on("DOMSubtreeModified",t),angular.element(document).on(o,function(e){e.target!=document?a=e.target.parentElement.offsetTop:a&&(r.scrollTop=a)}),n.on("scroll",function(){i=r.scrollTop==r.scrollHeight-r.offsetHeight}),e.$on("dividerTop",function(e,n){r.scrollTop=n})}return{link:e}}).directive("ngFocus",function(){function e(e,n){n[0].focus()}return{link:e}}).directive("divider",function(){function e(e,n){angular.element(document.getElementById("chat")).one("DOMSubtreeModified",function(){e.$emit("dividerTop",n[0].offsetTop-150)})}return{link:e}}).directive("ngTabActive",["$window","$rootScope","Title",function(e,n,t){function r(){angular.element(e).on("focus",function(){n.isTabActive=!0,n.$broadcast("tab-active",!0)}).on("blur",function(){n.isTabActive=!1,n.$broadcast("tab-active",!1)})}return{link:r}}]).directive("uniqueUsername",function(){function e(e,n,t,r){r.$validators.uniqueUsername=function(n){return!e.usernames.hasOwnProperty(n)}}return{require:"ngModel",link:e}}).directive("ngEnter",function(){function e(e,n){n.on("input",function(){n.css("height",n[0].scrollHeight+2+"px")}),n.on("keydown",function(t){13!=t.keyCode||t.shiftKey||(e.ngEnter(),n.css("height","34px"),t.preventDefault())})}return{scope:{ngEnter:"&"},link:e}}),angular.module("FlameSlackApp").factory("Auth",["$firebaseAuth","FB",function(e,n){return e(new Firebase(n))}]).factory("Users",["$firebaseArray","$firebaseObject","FB",function(e,n,t){var r=new Firebase(t+"users"),i=new Firebase(t+".info/connected"),a=e(r);return{getProfile:function(e){return n(r.child(e))},setOnline:function(t){var a=n(i);online=e(r.child(t+"/online")),a.$watch(function(){a.$value===!0&&online.$add(!0).then(function(){online.$ref().onDisconnect().remove()})}),r.child(t+"/lastOnline").onDisconnect().set(Firebase.ServerValue.TIMESTAMP)},setOffline:function(e){r.child(e+"/online").remove(),r.child(e+"/lastOnline").set(Firebase.ServerValue.TIMESTAMP)},isAdmin:function(e){return n(new Firebase(t).child("admins").child(e))},all:a}}]).factory("Usernames",["$firebaseObject","FB",function(e,n){return e(new Firebase(n+"usernames"))}]).factory("Channels",["$firebaseObject","FB",function(e,n){return e(new Firebase(n+"channels"))}]).factory("Messages",["$firebaseArray","FB",function(e,n){var t=new Firebase(n+"messages");return function(n){return e(t.child(n))}}]).factory("Direct",["$firebaseArray","$firebaseObject","FB",function(e,n,t){return{messages:function(n,r){var i=r>n?n+"/"+r:r+"/"+n;return e(new Firebase(t).child("direct").child(i))},notify:function(e,n){var r=new Firebase(t+"directNotification").child(n).child(e);r.transaction(function(e){return e?e+1:1})},notifications:function(e){return n(new Firebase(t+"directNotification").child(e))},removeNotifications:function(e,n){new Firebase(t+"directNotification").child(e).child(n).remove()}}}]).factory("Title",["$rootScope","FB",function(e,n){var t={set:function(n){e.title=n+" | Flame Slack"},add:function(n){~e.title.indexOf(n)||(e.title=n+e.title)},remove:function(n){n?~e.title.indexOf(n)&&(e.title=e.title.replace(n,"")):e.title=e.title.replace(/[\!\*] /g,"")}};return t}]),angular.module("FlameSlackApp").filter("code",function(){return function(e){return e.replace(/```([^`]+)```/g,"<pre>$1</pre>").replace(/`([^`]+)`/g,"<code>$1</code>")}}).filter("quote",function(){return function(e){return e.replace(/^>([^\n]+)$\n?/gm,"<blockquote>$1</blockquote>")}}).filter("link",["$http",function(e){var n=/(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})\/([\/\w\.\-=?]*)*\/?/gi,t=/\.(jpg|jpeg|png|gif)/,r=/(https?:\/\/)(www\.)?youtu\.?be(\.com)?\/(watch\?v=)?([\w\-_]+)(\?t=)?(\w+)?/i,i=/https?:\/\/vimeo\.com\/(\d+)/i;return function(a,o){return a.replace(n,function(n,a){var s='<a href="'+(a?"":"http://")+n+'" target="_blank">'+n+"</a>";if(t.test(n)&&!o.image&&(o.image={src:n}),r.test(n)&&!o.youtube&&(o.youtube={id:n.match(r)[5]}),i.test(n)&&!o.vimeo){var l=n.match(i)[1];o.vimeo={id:l},e.jsonp("https://vimeo.com/api/v2/video/"+l+".json?callback=JSON_CALLBACK").success(function(e){o.vimeo.preview=e[0].thumbnail_large})}return s})}}]).filter("username",["$rootScope",function(e){return function(n){var t=e.users.map(function(e){return e.username});return n.replace(/@(\w+)/,function(n,r){var i=e.user.username==r;return~t.indexOf(r)?(i&&e.$broadcast("mention"),'<a href="#/user/'+r+'"'+(i?'class="mention"':"")+">"+n+"</a>"):n})}}]).filter("channel",["$rootScope",function(e){return function(n){return n.replace(/#(\w+)/gi,function(n,t){return e.channels.hasOwnProperty(t)?'<a href="#/channels/'+t+'">'+n+"</a>":n})}}]).filter("trustAsHtml",["$sce",function(e){return e.trustAsHtml}]).filter("trustAsResourceUrl",["$sce",function(e){return e.trustAsResourceUrl}]),angular.module("FlameSlackApp").controller("ChannelCtrl",ChannelCtrl),ChannelCtrl.$inject=["$scope","$rootScope","$routeParams","$location","channels","isLogged","Messages","Users","Title","FB"],angular.module("FlameSlackApp").controller("DirectCtrl",DirectCtrl),DirectCtrl.$inject=["$scope","$rootScope","$routeParams","$location","usernames","isLogged","Channels","Users","Direct","FB"],angular.module("FlameSlackApp").controller("LoginCtrl",LoginCtrl),LoginCtrl.$inject=["$scope","$location","Auth","Users","isLogged"],angular.module("FlameSlackApp").controller("MainCtrl",MainCtrl),MainCtrl.$inject=["$scope","$rootScope","$location","Auth","Users","Usernames"],angular.module("FlameSlackApp").controller("RegisterCtrl",RegisterCtrl),RegisterCtrl.$inject=["$scope","$location","Auth","Users","usernames","isLogged"];
//# sourceMappingURL=app.min.js.map
